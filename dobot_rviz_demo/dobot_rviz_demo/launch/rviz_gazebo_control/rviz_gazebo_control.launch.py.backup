#!/usr/bin/env python3
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, ExecuteProcess
from launch.conditions import IfCondition
from launch.substitutions import LaunchConfiguration, Command, TextSubstitution
from launch_ros.actions import Node
from ament_index_python.packages import get_package_share_directory
import os

def generate_launch_description():
    use_rviz = LaunchConfiguration('use_rviz')
    use_gz   = LaunchConfiguration('use_gz')
    world    = LaunchConfiguration('world')
    lift_z   = LaunchConfiguration('lift_z')

    # Direct paths
    urdf_path = '/home/abdulhamid/dobot_rviz_ws/src/dobot_rviz_demo/dobot_rviz_demo/launch/rviz_gazebo_control/magician_lite_control.urdf'
    rviz_config_path = '/home/abdulhamid/dobot_rviz_ws/src/magician_ros2/dobot_description/rviz/display.rviz'
    robot_description = open(urdf_path).read()

    gz = ExecuteProcess(condition=IfCondition(use_gz),
                        cmd=['ign','gazebo','-r','-v','3','empty.sdf'],
                        output='screen')

    gz_spawn = Node(condition=IfCondition(use_gz),
                    package='ros_gz_sim', executable='create',
                    arguments=['-name','dobot_magician','-topic','/robot_description','-x','0','-y','0','-z','0'],
                    output='screen')

    return LaunchDescription([
        DeclareLaunchArgument('use_rviz', default_value='true'),
        DeclareLaunchArgument('use_gz',   default_value='true'),
        DeclareLaunchArgument('world',    default_value=''),
        DeclareLaunchArgument('lift_z',   default_value='0.15'),

        Node(package='robot_state_publisher', executable='robot_state_publisher',
             parameters=[{'robot_description': robot_description}], output='screen'),

        Node(package='joint_state_publisher_gui', executable='joint_state_publisher_gui',
             output='screen'),

        # Node to convert joint_states to individual joint commands
        ExecuteProcess(
            cmd=['python3', '/home/abdulhamid/dobot_rviz_ws/src/dobot_rviz_demo/dobot_rviz_demo/launch/rviz_gazebo_control/joint_state_to_commands.py'],
            output='screen'
        ),

        # Bridge for joint trajectory control
        Node(package='ros_gz_bridge', executable='parameter_bridge',
             arguments=['/joint_trajectory@trajectory_msgs/msg/JointTrajectory@gz.msgs.JointTrajectory'],
             output='screen'),

        Node(package='tf2_ros', executable='static_transform_publisher',
             arguments=['0','0', lift_z, '0','0','0','world','base_footprint'], output='screen'),

        Node(condition=IfCondition(use_rviz), package='rviz2', executable='rviz2',
             arguments=['-d', rviz_config_path], output='screen'),

        gz, gz_spawn,
    ])